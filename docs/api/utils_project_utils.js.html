<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils/project_utils.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils/project_utils.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Project manipulation utilities. Installs the dependencies defined in the project.json file.
 *
 * @package engine\utils
 * @author Valentin Duricu (valentin@duricu.ro)
 * @date 20.04.2015
 * @module utils/project_utils
 */
/*jslint node: true */
"use strict";

var unirest    = require('unirest'),
    OmenAPI    = require('./omen_api'),
    fs         = require('fs'),
    path       = require('path'),
    fstream    = require('fstream'),
    tar        = require('tar'),
    zlib       = require('zlib'),
    Download   = require('download'),
    Decompress = require("decompress"),
    Q          = require("q");

/**
 * Project manipulation utilities.
 *
 * @class
 */
var ProjectUtils = {};

/**
 * Checks if the given variable is valid or not.
 *
 * @param {Object} value The variable to be checked.
 * @return Boolean
 */
var _isValid = function (value) {
    return value !== undefined &amp;&amp; value !== null;
};

/**
 * Writes the omen lock file - used for the update command.
 *
 * @param {Object} cli The CLI object reference.
 * @param {Object} omenLock The properties to be written in the lock file.
 */
ProjectUtils.omenLockWrite = function (cli, omenLock) {
    cli.ok("Writing omen.lock file...");
    fs.writeFile(path.resolve("./omen.lock"), JSON.stringify(omenLock, null, 4));
};

/**
 * Writes the omen project file - used for the create command.
 *
 * @param {Object} cli The CLI object reference.
 * @param {Object} omenJson The properties to be written in the project file.
 */
ProjectUtils.omenJsonWrite = function (cli, omenJson) {
    cli.ok("Writing project.json file...");
    fs.writeFile(path.resolve("./" + omenJson.name + "/project.json"), JSON.stringify(omenJson, null, 4));
};

/**
 * For a given project builds the dependencies list that is sent to the server.
 *
 * @param {Project} project The project for which the dependencies are being built.
 * @return Array
 */
ProjectUtils.buildDependencies = function (project) {
    var versionPattern = new RegExp("^(&lt;|>|&lt;=|>=)?([0-9]+).((\\*|[0-9]+)(\.([0-9]+|\\*))?)$", "i"),
        returnDependencies = [],
        dependencies = project.get('dependencies'),
        i = 0;

    if (!_isValid(dependencies))
        return returnDependencies;


    for (var iElem in dependencies) {
        var app = iElem,
            verArr = versionPattern.exec(dependencies[iElem]),
            version = {};

        version.operator = verArr[1];
        if (!_isValid(version.operator))
            version.operator = "=";

        version.major = verArr[2];
        version.minor = verArr[4];
        version.patch = verArr[6];

        if (!_isValid(version.minor))
            version.minor = "0";
        else if (version.minor == "*")
            version.like = true;

        if (!_isValid(version.patch))
            version.patch = "0";
        else if (version.patch == "*")
            version.like = true;

        returnDependencies.push({
            package: app,
            version: version
        });
    }

    return returnDependencies;
};

/**
 * Performs a check of the dependencies on the server.
 *
 * @param {Array} dependencies The dependencies to be checked.
 * @param {Array} [update] The installed dependencies.
 * @return Promise
 */
ProjectUtils.checkDependencies = function (dependencies, update) {
    var deferred = Q.defer(),
        data = {deps: dependencies},
        url = '/dependency/check';

    /**
     * In case the update command is run, we must attach the
     * installed dependencies.
     */
    if (_isValid(update)) {
        data.installed = update;
        url = '/dependency/update';
    }

    /* The check of the dependencies is being done on the server. */
    unirest.post(OmenAPI.buildURL(url))
        .type('json')
        .send(data)
        .end(function (response) {
            if (response.statusType == 4 || response.statusType == 5)
                deferred.reject(new Error({status: response.status, body: response.body}));
            else
                deferred.resolve(response.body);
        });

    return deferred.promise;
};

/**
 * For the given dependencies, download them and store them locally.
 *
 * @param {Array} dependencies The dependencies to be downloaded.
 * @return Promise
 */
ProjectUtils.downloadDependencies = function (dependencies) {
    var downloads = (new Download({mode: '755'})).dest('./vendors'),
        deferred = Q.defer();

    /* Build the download list. */
    for (var i in dependencies) {
        downloads.get(dependencies[i]);
    }

    /* Downloads the files. */
    downloads.run(function (err, files) {
        if (err !== null &amp;&amp; err !== undefined) {
            deferred.reject(new Error(err));
            return;
        }

        deferred.resolve(files);
    });

    return deferred.promise;
};

/**
 * Publishes the local package to the system defined repository.
 *
 * @param {Project} project The information about the current package.
 * @param {Object} promptResult The password and other questions asked by the application.
 * @return Promise
 */
ProjectUtils.publish = function (project, promptResult) {
    var deferred, lines, data, fullPath;

    deferred = Q.defer();
    lines = [];
    fullPath = path.resolve('.');

    /* Try to read the file with ignore elements. */
    try {
        data = fs.readFileSync('.omenignore', "utf-8");
        lines = data.split(/\n/);
    } catch (err) {

    }

    /**
     * Create the package that will be sent to the repository.
     * We will create a .tar.gz2 file with .spk extension.
     * */
    var writer = fstream.Writer({'path': 'omenpackage.spk'});
    fstream.Reader({
        'path': '.',
        'type': 'Directory',
        filter: function () {
            var file = this.path.substring(fullPath.length);

            /* Filter some standard files to not be included in the package. */
            if (this.basename.match(/^\.git/) ||
                this.basename.match(/^vendors/) ||
                this.basename.match(/^omenpackage.spk/) ||
                this.basename.match(/^node_modules/))
                return false;

            /* Filter the files specified in .omenignore file. */
            for (var iLine in lines) {
                var line = lines[iLine].trim();

                if (this.basename.match(new RegExp(line)))
                    return false;

                if (file.match(new RegExp(line)))
                    return false;
            }

            return true;
        }
    })
        .pipe(tar.Pack())/* Convert the directory to a .tar file */
        .pipe(zlib.Gzip())/* Compress the .tar file */
        .pipe(writer);

    /* When the archive has been written to the fs, send it to the repository. */
    writer.on("close", function () {
        unirest.post(OmenAPI.buildURL('/publish/project'))
            .headers({'Accept': 'application/json'})
            .attach('file', './omenpackage.spk') // Attachment
            //.field("omenFile", JSON.stringify(project.all()))
            .field("omenFile", project.all())
            .field("user", project.get('author').email)
            .field("pass", promptResult.Password)
            .end(function (response) {
                //console.log(response.body);
                if (response.statusType == 4 || response.statusType == 5)
                    deferred.reject(new Error({status: response.status, body: response.body}));
                else
                    deferred.resolve(response.body);
            });
    });


    return deferred.promise;
};

/**
 * Performs the installation of the packages requested in the simple.json file.
 *
 * @param {Object} omenLock The lock file object.
 * @param {Object} cli The CLI object reference.
 * @param {Object} res The response from the server.
 */
ProjectUtils.install = function (omenLock, cli, res) {

    /* If there is an error, then notify the developer about it and end the execution. */
    if (res.status == "error") {
        cli.error("There were some errors:");
        for (var errorLine in res.errors) {
            var line = res.errors[errorLine];
            if (line.available !== null &amp;&amp; line.available !== undefined)
                cli.error("   - " + errorLine + ": " + line.message + " (Available: " + line.available + ")");
            else
                cli.error("   - " + errorLine + ": " + line.message);
        }

        return;
    }

    /* Check the existence of the vendors folder and create if it doesn't.*/
    if (!fs.existsSync("./vendors"))
        fs.mkdirSync("./vendors");

    if (res.dependencies !== null &amp;&amp; res.dependencies !== undefined) {
        cli.info("Downloading files");

        /* Download the dependencies. */
        ProjectUtils.downloadDependencies(res.dependencies).then(function (files) {
                throw new EvalError("Rewrite code");
                //var fullPath = path.resolve('./vendors/');
                //
                ///* Store the received dependencies in the lock object. */
                //for (var iPacks in res.packages) {
                //    omenLock.packages[res.packages[iPacks].package] = res.packages[iPacks].version;
                //}
                //
                ///* Store the lock object*/
                //ProjectUtils.omenLockWrite(cli, omenLock);
                //
                ///* Decompress each of the received files. */
                //for (var iFiles in files) {
                //    (new Decompress({mode: '755'}))
                //        .src(files[iFiles].path)
                //        .dest(fullPath)
                //        .use(Decompress.targz({strip: 1}))
                //        .run(function (err, archFiles) {
                //            var pack = res.packages[files[iFiles].path.substring(fullPath.length + 1)];
                //
                //            if (err) {
                //                cli.error("Problems installing: " + pack.package + " (version: " + pack.version + ") - ");
                //                cli.error(err);
                //                return;
                //            }
                //
                //            cli.ok("Package: " + pack.package + " (version: " + pack.version + ") - Installed");
                //        });
                //}
            },
            function (err) {
                /* In case an error is received, display it. */
                cli.error(err.message);
                cli.ok('====================================================');
            });
    }
    else
        ProjectUtils.omenLockWrite(cli, omenLock);

};

/**
 * Displays an error that occurs during the package installation.
 *
 * @param {Object} cli The CLI object reference.
 * @param {Object} err The error response.
 */
ProjectUtils.installError = function (cli, err) {
    /* In case an error is received, display it. */
    //console.log(JSON.stringify(err.message.body));
    cli.error("Got HTTP: " + err.message.status);
    cli.ok('====================================================');
};

module.exports = ProjectUtils;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-base_command.html">base/command</a></li><li><a href="module-base_spark.html">base/spark</a></li><li><a href="module-commands_about.html">commands/about</a></li><li><a href="module-commands_check.html">commands/check</a></li><li><a href="module-commands_create.html">commands/create</a></li><li><a href="module-commands_install.html">commands/install</a></li><li><a href="module-commands_publish.html">commands/publish</a></li><li><a href="module-commands_update.html">commands/update</a></li><li><a href="module-commands_version.html">commands/version</a></li><li><a href="module-engine_utils_cliMockup.html">engine/utils/cliMockup</a></li><li><a href="module-engine_utils_string_utils.html">engine/utils/string_utils</a></li><li><a href="module-project.html">project</a></li><li><a href="module-project_extras.html">project/extras</a></li><li><a href="module-project_mandatory.html">project/mandatory</a></li><li><a href="module-utils_command_utils.html">utils/command_utils</a></li><li><a href="module-utils_omen_api.html">utils/omen_api</a></li><li><a href="module-utils_project_utils.html">utils/project_utils</a></li></ul><h3>Classes</h3><ul><li><a href="module-base_command-CommandOmen.html">CommandOmen</a></li><li><a href="module-base_spark-Spark.html">Spark</a></li><li><a href="module-commands_about-AboutOmen.html">AboutOmen</a></li><li><a href="module-commands_check-CheckOmen.html">CheckOmen</a></li><li><a href="module-commands_create-CreateOmen.html">CreateOmen</a></li><li><a href="module-commands_install-InstallOmen.html">InstallOmen</a></li><li><a href="module-commands_publish-PublishOmen.html">PublishOmen</a></li><li><a href="module-commands_update-UpdateOmen.html">UpdateOmen</a></li><li><a href="module-commands_version-VersionOmen.html">VersionOmen</a></li><li><a href="module-engine_utils_cliMockup-CliMockup.html">CliMockup</a></li><li><a href="module-project_extras-ProjectExtras.html">ProjectExtras</a></li><li><a href="module-project_mandatory-ProjectMandatory.html">ProjectMandatory</a></li><li><a href="module-project.html#~Project">Project</a></li><li><a href="module-utils_command_utils-CommandUtils.html">CommandUtils</a></li><li><a href="module-utils_omen_api-OmenAPI.html">OmenAPI</a></li><li><a href="module-utils_project_utils-ProjectUtils.html">ProjectUtils</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta3</a> on Wed May 20 2015 18:51:45 GMT+0300 (EEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
